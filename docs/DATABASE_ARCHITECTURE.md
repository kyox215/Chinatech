# 数据库架构设计规范 (Database Architecture Guide)

本文档旨在为 **ChinaTechOS** 的多应用生态系统建立统一的数据库管理规则。随着应用数量的增加（如回收报价、设计工具、视频制作等），规范化的数据库结构对于数据隔离、互通及系统维护至关重要。

## 1. 核心原则 (Core Principles)

1.  **应用隔离 (App Isolation)**: 每个应用应拥有自己独立的表集合，不与其他应用混用业务表。
2.  **统一身份 (Unified Identity)**: 所有应用共享同一个用户系统 (`auth.users`)，通过 `user_id` 进行关联。
3.  **命名规范 (Naming Convention)**: 严格遵守命名空间前缀，防止表名冲突。

---

## 2. 命名规范 (Naming Conventions)

所有数据库表名必须遵循以下格式：

```
[app_id]_[entity_name]
```

*   **app_id**: 应用的唯一标识符（小写，下划线分隔）。
*   **entity_name**: 表存储的数据实体名称（复数形式）。

### 示例

| 应用名称 | App ID | 实体 | 推荐表名 | 说明 |
| :--- | :--- | :--- | :--- | :--- |
| **核心系统** | `core` | 用户资料 | `core_profiles` | 存储昵称、头像等公开信息 |
| | | 系统日志 | `core_audit_logs` | 全局操作日志 |
| **回收报价** | `recycling` | 手机机型 | `recycling_models` | 存储 iPhone/Android 机型数据 |
| | | 回收订单 | `recycling_orders` | 用户提交的回收请求 |
| | | 配置参数 | `recycling_configs` | 扣款规则、价格系数 |
| **像素大师** | `pixel` | 项目文件 | `pixel_projects` | 图片编辑项目 |
| | | 素材库 | `pixel_assets` | 用户上传的图片素材 |

---

## 3. 核心层设计 (Core Layer)

核心层表用于存储跨应用共享的数据。

### 3.1 用户资料表 (`core_profiles`)

虽然 Supabase 提供了 `auth.users`，但我们通常需要一个公开的表来存储业务相关的用户信息。

```sql
create table core_profiles (
  id uuid references auth.users not null primary key, -- 关联 Supabase Auth
  username text unique,
  avatar_url text,
  full_name text,
  tier text default 'free', -- 会员等级: free, pro, enterprise
  updated_at timestamp with time zone,
  
  constraint username_length check (char_length(username) >= 3)
);
```

---

## 4. 应用层设计与关联 (App Layer & Relationships)

每个应用通过 `Foreign Key` (外键) 与核心层进行交互。

### 示例：回收订单表 (`recycling_orders`)

```sql
create table recycling_orders (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users not null, -- 核心关联：哪个用户提交的订单
  model_id bigint references recycling_models(id), -- 应用内关联：什么机型
  
  final_price numeric not null,
  status text default 'pending', -- pending, completed, cancelled
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);
```

### 跨应用数据读取 (Cross-App Data Access)

当需要在后台管理系统中展示“用户画像”时，可以通过 SQL `JOIN` 轻松聚合数据：

```sql
-- 示例：查询某个用户的所有回收订单及用户信息
select 
  p.username,
  p.tier,
  o.id as order_id,
  o.final_price,
  o.status
from recycling_orders o
join core_profiles p on o.user_id = p.id
where o.status = 'completed';
```

---

## 5. 安全策略 (Row Level Security - RLS)

每个应用必须为自己的表定义 RLS 策略，确保数据安全。

**基本规则：**
1.  **用户只能读取/修改自己的数据** (`auth.uid() = user_id`).
2.  **管理员可以读取/修改所有数据** (检查 `core_profiles.tier` 或特定角色表).
3.  **公共数据 (如机型表) 对所有人只读**.

```sql
-- 示例：启用 RLS
alter table recycling_orders enable row level security;

-- 策略：用户只能看自己的订单
create policy "Users can view own orders"
on recycling_orders for select
using ( auth.uid() = user_id );

-- 策略：仅允许插入自己的订单
create policy "Users can insert own orders"
on recycling_orders for insert
with check ( auth.uid() = user_id );
```

## 6. 管理与维护规划

为方便管理，建议后续开发：
1.  **统一后台 (Admin Dashboard)**: 一个超级管理员应用，有权限读取所有 `[app_id]_*` 表。
2.  **数据迁移脚本**: 在 `scripts/` 目录下维护每个应用的 SQL 迁移文件 (如 `scripts/migrations/01_recycling_schema.sql`).

遵循此规范，ChinaTechOS 可以无限扩展新的应用模块，同时保持数据结构的清晰和可维护性。
