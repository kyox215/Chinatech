generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id      String   @id @default(cuid())
  email   String   @unique
  role    String   @default("USER")
  tickets Ticket[]
  repairOrders RepairOrder[]
  orderLogs OrderLog[]
}

model Ticket {
  id        String       @id @default(cuid())
  status    String       @default("PENDING")
  userId    String
  user      User         @relation(fields: [userId], references: [id])
  partsUsed TicketPart[]
}

model Part {
  id      String       @id @default(cuid())
  name    String
  stock   Int
  tickets TicketPart[]
}

model TicketPart {
  ticketId String
  partId   String
  quantity Int
  part     Part   @relation(fields: [partId], references: [id])
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  @@id([ticketId, partId])
}

model Quote {
  id          String   @id @default(cuid())
  brand       String
  model       String
  repairId    String   @unique @map("repair_id")
  repairLabel String   @map("repair_label")
  repairType  String   @map("repair_type")
  quality     String
  price       Float
  warranty    String
  count       Int      @default(0)
  isUnstable  Boolean  @default(false) @map("is_unstable")
  priceSpread String?  @map("price_spread")
  sourceHash   String?  @map("source_hash")
  sourceVersion Int      @default(1) @map("source_version")
  isActive     Boolean   @default(true) @map("is_active")
  lastSeenAt   DateTime? @map("last_seen_at")
  lastSeenBatchId String? @map("last_seen_batch_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("quotes")
  @@index([brand])
  @@index([model])
  @@index([repairType])
  @@index([brand, model])
  @@index([repairId]) // Added index for repairId lookups
  @@unique([brand, model, repairLabel, quality])
}

model Product {
  id        String   @id @default(cuid())
  sku       String?  @unique
  brand     String
  model     String
  status    String   @default("ACTIVE")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  quoteItems QuoteItem[]

  @@map("products")
  @@index([brand])
  @@index([model])
}

model Customer {
  id           String   @id @default(cuid())
  externalId   String?  @unique @map("external_id")
  name         String
  phone        String?  // Added
  email        String?  // Added
  address      String?  // Added
  taxId        String?  @map("tax_id") // P.IVA / CF
  notes        String?
  type         String   @default("RETAIL")
  discountRate Float    @default(0) @map("discount_rate")
  status       String   @default("ACTIVE")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  quoteHeaders QuoteHeader[]
  repairOrders RepairOrder[]

  @@map("customers")
  @@index([type])
  @@index([phone])
  @@index([email])
}

model RepairOrder {
  id        String   @id @default(cuid())
  orderNo   String   @unique @map("order_no") // Readable ID e.g. REP-2024-001
  
  // Customer Relation
  customerId String?  @map("customer_id")
  customer   Customer? @relation(fields: [customerId], references: [id])
  
  // Technician Relation
  technicianId String? @map("technician_id")
  technician   User?   @relation(fields: [technicianId], references: [id])

  // Device Details
  brand       String
  model       String
  imeiOrSn    String?  @map("imei_or_sn")
  color       String?
  passcode    String?
  pattern     String?  // JSON or SVG path for lock pattern
  condition   String?  // Physical condition notes

  // Issue & Service
  problem     String   // Customer stated problem
  diagnosis   String?  // Technician diagnosis
  privateNotes String? @map("private_notes")
  
  // Status
  status      String   @default("PENDING") // PENDING, DIAGNOSING, WAITING_PARTS, REPAIRED, DELIVERED, CANCELLED
  priority    String   @default("NORMAL")  // LOW, NORMAL, HIGH, URGENT

  // Financials
  estimatedPrice Float? @map("estimated_price")
  finalPrice     Float? @map("final_price")
  deposit        Float  @default(0)
  isPaid         Boolean @default(false) @map("is_paid")
  paymentMethod  String? @map("payment_method") // CASH, CARD, TRANSFER
  warranty       String? // e.g. "6 Months"

  // Dates
  intakeDate      DateTime  @default(now()) @map("intake_date")
  estimatedDate   DateTime? @map("estimated_date")
  completedDate   DateTime? @map("completed_date")
  pickupDate      DateTime? @map("pickup_date")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  logs OrderLog[]

  @@map("repair_orders")
  @@index([status])
  @@index([orderNo])
  @@index([customerId])
  @@index([brand, model])
}

model OrderLog {
  id            String      @id @default(cuid())
  repairOrderId String      @map("repair_order_id")
  repairOrder   RepairOrder @relation(fields: [repairOrderId], references: [id])
  userId        String?     @map("user_id") // Who made the change
  user          User?       @relation(fields: [userId], references: [id])
  
  action        String      // STATUS_CHANGE, NOTE_ADDED, PRICE_UPDATE
  details       String?     // JSON or text details
  
  createdAt     DateTime    @default(now()) @map("created_at")

  @@map("order_logs")
  @@index([repairOrderId])
}

model QuoteHeader {
  id           String   @id @default(cuid())
  quoteNo      String   @unique @map("quote_no")
  customerId   String?  @map("customer_id")
  customer     Customer? @relation(fields: [customerId], references: [id])
  status       String   @default("DRAFT")
  effectiveAt  DateTime? @map("effective_at")
  currency     String   @default("EUR")
  notes        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  items QuoteItem[]

  @@map("quote_headers")
}

model QuoteItem {
  id          String   @id @default(cuid())
  headerId    String   @map("header_id")
  header      QuoteHeader @relation(fields: [headerId], references: [id])
  productId   String?  @map("product_id")
  product     Product? @relation(fields: [productId], references: [id])
  repairLabel String   @map("repair_label")
  repairType  String   @map("repair_type")
  quality     String
  unitPrice   Float    @map("unit_price")
  warranty    String
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  priceHistory PriceHistory[]

  @@map("quote_items")
  @@index([headerId])
  @@index([productId])
}

model PriceHistory {
  id        String   @id @default(cuid())
  itemId    String   @map("item_id")
  item      QuoteItem @relation(fields: [itemId], references: [id])
  oldPrice  Float?    @map("old_price")
  newPrice  Float     @map("new_price")
  changedAt DateTime  @default(now()) @map("changed_at")
  changeReason String? @map("change_reason")
  checksum  String?   @map("checksum")
  version   Int       @default(1)

  @@map("price_history")
  @@index([itemId])
}

model ImportBatch {
  id         String   @id @default(cuid())
  batchId    String   @unique @map("batch_id")
  fileName   String?  @map("file_name")
  fileHash   String?  @map("file_hash")
  startedAt  DateTime @default(now()) @map("started_at")
  finishedAt DateTime? @map("finished_at")
  status     String   @default("RUNNING")

  @@map("import_batches")
}

model SyncLog {
  id          String   @id @default(cuid())
  batchId     String   @map("batch_id")
  operation   String
  entity      String
  key         String?
  message     String?
  count       Int      @default(0)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("sync_logs")
  @@index([batchId])
}

model RecycleModel {
  id               String   @id @default(cuid())
  model            String   @unique
  screenPrice      Float    @map("screen_price")
  batteryPrice     Float    @map("battery_price")
  baseRecyclePrice Float    @map("base_recycle_price")
  releaseYear      Int      @map("release_year")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("recycle_models")
  @@index([releaseYear])
}

model RecycleOrder {
  id        String   @id @default(cuid())
  orderNo   String   @unique @default(cuid()) @map("order_no")
  model     String
  storage   String
  condition String
  battery   String
  screen    String
  price     Float
  status    String   @default("PENDING")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("recycle_orders")
  @@index([status])
  @@index([createdAt])
}
